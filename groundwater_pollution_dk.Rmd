---
title: "groundwater_pollution_dk"
author: "Johan Horsmans"
date: "4/26/2021"
output: github_document
---

### Loading packages
```{r}
library(pacman)

p_load(sf, raster, dplyr, tmap, ggplot2, tidyverse, lubridate, sp, gstat)
```

### Loading nitrate data:
```{r}
nitrate <- as.data.frame(read_csv("data/nitrate.csv")) #Load the .csv-file as a dataframe and save it as "nitrate".

#Rename columns to remove spaces:
names(nitrate)[names(nitrate) == "Seneste"] <- "Seneste_m책ling" 
names(nitrate)[names(nitrate) == "Seneste mg/l"] <- "Seneste_mgl"
names(nitrate)[names(nitrate) == "Indtag topdybde"] <- "Indtag_topdybde" 


```

### Remove outliers
```{r}
nitrate <- nitrate %>%
  filter_at(vars("Seneste_mgl"), any_vars(. < 200))

nitrate <- nitrate %>%
  filter_at(vars("Indtag_topdybde"), any_vars(. > 0))

```


### Processing the nitrate.csv-file into a compatible format.
```{r}
nitrate$WKT <- as.character(nitrate$WKT)
nitrate$WKT <- gsub("POINT \\(", "", nitrate$WKT)
nitrate$WKT <- gsub(")", "", nitrate$WKT)
```

### Separate into two columns
```{r}
nitrate <- nitrate %>% 
  separate(col = WKT, into = c("longitude","latitude"), sep = " ")
```

### Making it a shapefile
```{r}
nitrate <- st_as_sf(nitrate, coords = c("longitude", "latitude"))
```

### Loading land-use data.
```{r}
markblok<-st_read("data/Markblok.shp") %>% na.omit()

okologimark_2012<-st_read("data/Oekologiske_arealer_2012.shp") %>% na.omit()
okologimark_2013<-st_read("data/Oekologiske_arealer_2013.shp") %>% na.omit()
okologimark_2014<-st_read("data/Oekologiske_arealer_2014.shp") %>% na.omit()
okologimark_2015<-st_read("data/Oekologiske_arealer_2015.shp") %>% na.omit()
okologimark_2016<-st_read("data/Oekologiske_arealer_2016.shp") %>% na.omit()
okologimark_2017<-st_read("data/Oekologiske_arealer_2017.shp") %>% na.omit()
okologimark_2018<-st_read("data/Oekologiske_arealer_2018.shp") %>% na.omit()
okologimark_2019<-st_read("data/Oekologiske_arealer_2019.shp") %>% na.omit()
okologimark_2020<-st_read("data/Oekologiske_arealer_2020.shp") %>% na.omit()

oko_geo <- okologimark_2012$geometry
okologimark_2012 <- as_Spatial(oko_geo)
oko_geo <- okologimark_2013$geometry
okologimark_2013 <- as_Spatial(oko_geo)
oko_geo <- okologimark_2014$geometry
okologimark_2014 <- as_Spatial(oko_geo)
oko_geo <- okologimark_2015$geometry
okologimark_2015 <- as_Spatial(oko_geo)
oko_geo <- okologimark_2016$geometry
okologimark_2016 <- as_Spatial(oko_geo)
oko_geo <- okologimark_2017$geometry
okologimark_2017 <- as_Spatial(oko_geo)
oko_geo <- okologimark_2018$geometry
okologimark_2018 <- as_Spatial(oko_geo)
oko_geo <- okologimark_2019$geometry
okologimark_2019 <- as_Spatial(oko_geo)
oko_geo <- okologimark_2020$geometry
okologimark_2020 <- as_Spatial(oko_geo)


okologimark<-raster::bind(okologimark_2019,okologimark_2020, okologimark_2018, okologimark_2017, okologimark_2016, okologimark_2015, okologimark_2014, okologimark_2013, okologimark_2012)


head(markblok)
head(okologimark)
head(nitrate)
```
### Plotting fields
```{r}
plot(okologimark)
plot(st_geometry(markblok))
```

### Setting CRS
```{r}
# Set the projection of the nitrate data as EPSG 25832
nitrate <- st_set_crs(nitrate, value = 25832)

#Set of okologi:
#CRS("+init=epsg:25832")
proj4string(okologimark) <- CRS("+init=epsg:25832")
okologimark <- spTransform(okologimark, CRS("+init=epsg:25832"))

# SET MARKBLOK
markblok <- st_set_crs(markblok, value = 25832)

# Transform the geometry of the data to the assigned CRS. 
nitrate <- st_transform(nitrate, crs=25832)
markblok <- st_transform(markblok, crs=25832)
#okologimark <- st_transform(okologimark, crs = 25832)

# Verify the projection is 'projected' not 'geographic'
head(nitrate) 
head(markblok)
head(okologimark)
```

### Filtering dates between 2018 and 2021:
```{r}
nitrate <- nitrate %>%
 select(Seneste_m책ling, Seneste_mgl, geometry, Indtag_topdybde) %>%
 filter(Seneste_m책ling >= as.Date("2018-01-01") & Seneste_m책ling <= as.Date("2021-03-10"))
```

### Remove duplicate entries (for the purpose of kriging)
```{r}
nitrate<-nitrate[!duplicated(nitrate$geometry), ]
```

### Plotting the points
```{r}
plot(st_geometry(nitrate), pch = 16, cex = 0.4)
```

### Plotting points on top of organic fields (to assess CRS allignment)
```{r}
plot(st_geometry(nitrate), pch = 16, cex = 0.4, col = "red")
plot(okologimark, add = TRUE)
```

### Plotting points on top of all fields (to assess CRS allignment)
```{r}
plot(st_geometry(markblok))
plot(st_geometry(nitrate), add = TRUE, pch = 16, cex = 0.4, col = "red")
```


### Exploratory statistics:

Depth:
```{r}
summary(nitrate$Indtag_topdybde)
sd(nitrate$Indtag_topdybde)
```

### Nitrate:
```{r}
summary(nitrate$Seneste_mgl)
```
```{r}
hist(nitrate$Seneste_mgl)
```

### Plotting points with nitrate per. mg/l metric:
```{r}
ggplot(nitrate) +
  geom_sf(aes(col = Seneste_mgl))
```

### Kriging:

Creating X- and Y-value columns
```{r}
nitrate$X <- st_coordinates(nitrate)[,1]
nitrate$Y <- st_coordinates(nitrate)[,2]
```


### Make variogram by fitting X- and Y coordinates to nitrate mg/l with a linear regression
```{r}
vgm <- variogram(nitrate$Seneste_mgl ~ X + Y, nitrate)
plot(vgm)
```

ADELAS TEXT: "You might imagine that if soil at a particular point is nutrient-rich, then soil one metre away is likely to be fertile too. But can you say the same thing about soil one kilometre away, or ten kilometres, or one hundred kilometres?"

JOHANS TEXT: "It appears that it is very hard to find spatial correlations in the data. Nonetheles, it appears that the first 30000 (units) are more correlated than those further away. As such, we argue that this model can be used for kriging, since it only needs to interpolate data that is close to "real" data".

Fit a model to the variogram:

```{r}
# Eyeball the variogram and estimate the initial parameters (ADELA TEXT)
nugget <- 550
psill <- -360
range <- 45000
# Fit the variogram (ADELA TEXT)
v_model <- fit.variogram(
  vgm, 
  model = vgm(
    model = "Ste",
    nugget = nugget,
    psill = psill,
    range = range,
    kappa = 0.5
  )
)
# Show the fitted variogram on top of the binned variogram (ADELA TEXT)
plot(vgm, model = v_model)
print(v_model)
```

### Create prediction grid (ALL COMMENTING IS ADELA)
```{r}
st_bbox(nitrate)
# Define a 0.5km square grid over the polygon extent. The first parameter is the bottom left corner.

grid <- GridTopology(c(430734,6040448), c(2000, 2000), c(236, 190))
# Create points with the same coordinate system as the boundary box
crs(nitrate)
gridpoints <- SpatialPoints(grid, proj4string = CRS(projection("+proj=utm +zone=32 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs "))) # CHECK CRS

# Convert to SpatialPixels
spgrid <- SpatialPixels(gridpoints)
coordnames(spgrid) <- c("X", "Y")
plot(spgrid)
```


### Using fitted variogram model to interpolate new data to the grid

ADELA: "Use the spatial pixel grid of the region, `spgrid`, and the variogram model of OM, `v_model` from previous exercises."

```{r}
# Adjust the kaz_geo CRS to be consistent with spgrid
crs(as(nitrate, "Spatial"), asText = TRUE) == crs(spgrid, asText = TRUE)
# Despite the statement above krige() is erroring out due to CRS misalignment, so forcing it here:
nitrate_sp <- as(nitrate, "Spatial")
crs(nitrate_sp) <- crs(spgrid)
# Do kriging predictions over the grid
nitrate_grid <- krige(Seneste_mgl ~ X + Y, nitrate_sp, newdata = spgrid, model = v_model)
# Plot the soil-nutrient predictions in a grid



#UNIQUE:
#Plotting raster:
tm_shape(nitrate_grid[1])  +
  tm_raster(title = "Nitrate mg/l", 
            style = "cont",
            palette = "-RdYlGn") +
  tm_credits(text = "Johan Horsmans & Emil Jessen") +
  tm_layout(main.title = "Nitrate pollution map")


#Points overlayed on raster:
tm_shape(nitrate_grid[1])  +
  tm_raster(title = "Nitrate mg/l", 
            style = "cont",
            palette = "-RdYlGn") +
tm_shape(nitrate) +
  tm_dots()
###

```

### Load DK map
```{r}
DK<-st_read("data/denmark_administrative_outline_boundary.shp")
```

### Inspect CRS
```{r}
head(DK)
```

### Set CRS
```{r}
# Set the projection of the nitrate data as EPSG 25832
DK <- st_set_crs(DK, value = 4326)

# Transform the geometry of the data to the assigned CRS. 
DK <- st_transform(DK, crs=25832)
```

### Inspect CRS
```{r}
head(DK)
```

```{r}
#Plotting raster:
tm_shape(nitrate_grid[1])  +
  tm_raster(title = "Nitrate mg/l", 
            style = "cont",
            palette = "-RdYlGn") +
  tm_credits(text = "Johan Horsmans & Emil Jessen") +
  tm_layout(main.title = "Nitrate pollution map") +
#Points overlayed on raster:
tm_raster(title = "Nitrate mg/l", 
            style = "cont",
            palette = "-RdYlGn") +
tm_shape(nitrate) +
  tm_dots() +
#Adding DK-map
tm_shape(DK) + 
  tm_polygons(alpha = 0.3)

```

```{r}
#Plotting raster:
tm_shape(nitrate_grid[1])  +
  tm_raster(title = "Nitrate mg/l", 
            style = "cont",
            palette = "-RdYlGn") +
  tm_credits(text = "Johan Horsmans & Emil Jessen") +
  tm_layout(main.title = "Nitrate pollution map") +
#Points overlayed on raster:
tm_raster(title = "Nitrate mg/l", 
            style = "cont",
            palette = "-RdYlGn") +
tm_shape(nitrate) +
  tm_dots() +
#Adding DK-map
tm_shape(okologimark) + 
  tm_polygons(col = "lightblue")
```
### Cropped map
```{r}
r <- raster(nitrate_grid)


nitrate_grid_cropped <- crop(r, extent(DK_geo2))
nitrate_grid_cropped <- raster::mask(r, DK_geo2)

```

```{r}
#Plotting raster:
tm_shape(nitrate_grid_cropped)  +
  tm_raster(title = "Nitrate mg/l", 
            style = "cont",
            palette = "-RdYlGn") +
  tm_credits(text = "Johan Horsmans & Emil Jessen") +
  tm_layout(main.title = "Nitrate pollution map",
            legend.position = c("right","top"),
            legend.bg.color = "white", legend.bg.alpha = .2, 
            legend.frame = "gray50",
            bg.color = "lightblue") +
#Points overlayed on raster:
tm_shape(nitrate) +
  tm_dots() +
#Adding DK-map
tm_shape(DK) + 
  tm_polygons(alpha = 0.3)
```


### ECO
```{r}
r <- raster(nitrate_grid)
#oko_geo <- okologimark$geometry
#okologimark2 <- as_Spatial(oko_geo)
```

```{r}
# TEST
r2 <- raster(ncol=36, nrow=18, vals=1.0:(18*36))

cds1 <- rbind(c(-180,-20), c(-160,5), c(-60, 0), c(-160,-60), c(-180,-20))
cds2 <- rbind(c(80,0), c(100,60), c(120,0), c(120,-55), c(80,0))
polys <- spPolygons(cds1, cds2)

agri_s2=raster::extract(x=r, y=polys, fun=mean, df=TRUE)

r2[648]
```


```{r}
library(raster) # use the raster library
eco_extraction=suppressWarnings(raster::extract(x=r, y=okologimark, fun=mean, df=TRUE, na.rm=TRUE))

eco_extraction$land_type<-"ecological"

```


### Markblok
```{r}

r <- raster(nitrate_grid)
mb_geo <- sample(markblok$geometry, length(okologimark))
markblok2 <- as_Spatial(mb_geo)
```

```{r}
mb_extraction=suppressWarnings(raster::extract(x=r, y=markblok2, fun=mean, df=TRUE, na.rm=TRUE))
mb_extraction$land_type<-"conventional"

```

```{r}
t.test(eco_extraction$var1.pred, mb_extraction$var1.pred)
```

```{r}
p_load(lmtest)
```

```{r}
merged<-rbind(eco_extraction, mb_extraction)
```


```{r}
bi_model <- lm(var1.pred ~ land_type, data = merged)

coeftest(bi_model, type = "HC1")

```

### DEPTH PENALTY:
```{r}
nitrate <- as.data.frame(read_csv("data/nitrate.csv")) #Load the .csv-file as a dataframe and save it as "nitrate".

#Rename columns to remove spaces:
names(nitrate)[names(nitrate) == "Seneste mg/l"] <- "Seneste_mgl"
names(nitrate)[names(nitrate) == "Indtag topdybde"] <- "Indtag_topdybde" 

nitrate <- nitrate %>%
  filter_at(vars("Seneste_mgl"), any_vars(. < 200))

nitrate <- nitrate %>%
  filter_at(vars("Indtag_topdybde"), any_vars(. > 0))

p<-ggplot(nitrate, aes(Indtag_topdybde, Seneste_mgl)) +
  geom_point()

  
# loess method: local regression fitting
p + geom_smooth(method = "loess")

###


ggplot(cars, aes(speed, dist)) +
  geom_point()
# Add regression line
p + geom_smooth(method = lm)
  
# loess method: local regression fitting
p + geom_smooth(method = "loess")

```

