---
title: "groundwater_pollution_dk"
author: "Johan Horsmans"
date: "4/26/2021"
output: github_document
---

### Loading packages
```{r}
library(pacman)

p_load(sf, raster, dplyr, tmap, ggplot2, tidyverse, lubridate, sp, gstat)
```

### Loading nitrate data:
```{r}
nitrate <- as.data.frame(read_csv("data/nitrate.csv")) #Load the .csv-file as a dataframe and save it as "nitrate".

#Rename columns to remove spaces:
names(nitrate)[names(nitrate) == "Seneste"] <- "Seneste_måling" 
names(nitrate)[names(nitrate) == "Seneste mg/l"] <- "Seneste_mgl"
```

### Remove outliers
```{r}
nitrate <- nitrate %>%
  filter_at(vars("Seneste_mgl"), any_vars(. < 200))
```


### Processing the nitrate.csv-file into a compatible format.
```{r}
nitrate$WKT <- as.character(nitrate$WKT)
nitrate$WKT <- gsub("POINT \\(", "", nitrate$WKT)
nitrate$WKT <- gsub(")", "", nitrate$WKT)
```

### Separate into two columns
```{r}
nitrate <- nitrate %>% 
  separate(col = WKT, into = c("longitude","latitude"), sep = " ")
```

### Making it a shapefile
```{r}
nitrate <- st_as_sf(nitrate, coords = c("longitude", "latitude"))
```

### Loading land-use data.
```{r}
markblok<-st_read("data/Markblok.shp") %>% na.omit()
okologimark<-st_read("data/Oekologiske_arealer_2019.shp") %>% na.omit()


head(markblok)
head(okologimark)
head(nitrate)
```
### Plotting fields
```{r}
plot(st_geometry(okologimark))
plot(st_geometry(markblok))
```

### Emils code trying to fix okologimarker! 
```{r}
# Looking at original data -> It appears more than 1000 fields are registered (which is > our dataset)
https://miljoegis.mim.dk/spatialmap?profile=lbst

# Too few fields are apparent here in R (regardless of plotting method )
plot(st_geometry(okologimark))
tm_shape(okologimark) + tm_polygons()

# Enough rows do not seem to be included
nrow(markblok)
nrow(okologimark)
length(st_geometry(okologimark))

# Subsetting df to only include "Omlægningsdato efter 31/5-2019", as shown on website
str(okologimark$Omlaegning)
new_okologimark = okologimark %>%
 filter(Omlaegning >= as.Date("2019-05-31"))

# Plotting only the new omlaegning
plot(st_geometry(new_okologimark))
tm_shape(new_okologimark) + tm_polygons()

# Inspecting the individual rows of "geometry"
print(okologimark$geometry[1,])[1][1][1]

# Method for merging different okologimarker in case we need it
okologimark18 <-st_read("data/Oekologiske_arealer_2018.shp") %>% na.omit()
okologimark19 <-st_read("data/Oekologiske_arealer_2019.shp") %>% na.omit()

okologimark18 = st_union(okologimark18)
okologimark19 = st_union(okologimark19)
okologimark1819 = st_union(okologimark18, okologimark19)
plot(st_geometry(okologimark1819))


```



### Setting CRS
```{r}
# Set the projection of the nitrate data as EPSG 25832
nitrate <- st_set_crs(nitrate, value = 25832)
okologimark <- st_set_crs(okologimark, value = 25832)
markblok <- st_set_crs(markblok, value = 25832)

# Transform the geometry of the data to the assigned CRS. 
nitrate <- st_transform(nitrate, crs=25832)
markblok <- st_transform(markblok, crs=25832)
okologimark <- st_transform(okologimark, crs = 25832)

# Verify the projection is 'projected' not 'geographic'
head(nitrate) 
head(markblok)
head(okologimark)
```

### Filtering dates between 2018 and 2021:
```{r}
nitrate <- nitrate %>%
 select(Seneste_måling, Seneste_mgl, geometry, `Indtag topdybde`) %>%
 filter(Seneste_måling >= as.Date("2018-01-01") & Seneste_måling <= as.Date("2021-03-10"))
```

### Remove duplicate entries (for the purpose of kriging)
```{r}
nitrate<-nitrate[!duplicated(nitrate$geometry), ]
```

### Plotting the points
```{r}
plot(st_geometry(nitrate), pch = 16, cex = 0.4)
```

### Plotting points on top of organic fields (to assess CRS allignment)
```{r}
plot(st_geometry(nitrate), pch = 16, cex = 0.4, col = "red")
plot(st_geometry(okologimark), add = TRUE)
```

### Plotting points on top of all fields (to assess CRS allignment)
```{r}
plot(st_geometry(markblok))
plot(st_geometry(nitrate), add = TRUE, pch = 16, cex = 0.4, col = "red")
```


### Exploratory statistics:

Depth:
```{r}
summary(nitrate$`Indtag topdybde`)
sd(nitrate$`Indtag topdybde`)
```

### Nitrate:
```{r}
summary(nitrate$Seneste_mgl)
```
```{r}
hist(nitrate$Seneste_mgl)
```

### Plotting points with nitrate per. mg/l metric:
```{r}
ggplot(nitrate) +
  geom_sf(aes(col = Seneste_mgl))
```

### Kriging:

Creating X- and Y-value columns
```{r}
nitrate$X <- st_coordinates(nitrate)[,1]
nitrate$Y <- st_coordinates(nitrate)[,2]
```


### Make variogram by fitting X- and Y coordinates to nitrate mg/l with a linear regression
```{r}
vgm <- variogram(nitrate$Seneste_mgl ~ X + Y, nitrate)
plot(vgm)
```

ADELAS TEXT: "You might imagine that if soil at a particular point is nutrient-rich, then soil one metre away is likely to be fertile too. But can you say the same thing about soil one kilometre away, or ten kilometres, or one hundred kilometres?"

JOHANS TEXT: "It appears that it is very hard to find spatial correlations in the data. Nonetheles, it appears that the first 30000 (units) are more correlated than those further away. As such, we argue that this model can be used for kriging, since it only needs to interpolate data that is close to "real" data".

Fit a model to the variogram:

```{r}
# Eyeball the variogram and estimate the initial parameters (ADELA TEXT)
nugget <- 550
psill <- -360
range <- 45000
# Fit the variogram (ADELA TEXT)
v_model <- fit.variogram(
  vgm, 
  model = vgm(
    model = "Ste",
    nugget = nugget,
    psill = psill,
    range = range,
    kappa = 0.5
  )
)
# Show the fitted variogram on top of the binned variogram (ADELA TEXT)
plot(vgm, model = v_model)
print(v_model)
```

### Create prediction grid (ALL COMMENTING IS ADELA)
```{r}
# Create geo_bounds bounding box for kaz_geo 
geo_bounds <- st_make_grid(nitrate$geometry, n=1)
# Plot the bounding box polygon and points
plot(nitrate$geometry); plot(geo_bounds, add= TRUE) 
# Find the left bottom corner of the bounding box
st_bbox(nitrate)
# Define a 0.5km square grid over the polygon extent. The first parameter is the bottom left corner.

grid <- GridTopology(c(446734,6054448), c(2000, 2000), c(222, 173))
# Create points with the same coordinate system as the boundary box
crs(nitrate)
gridpoints <- SpatialPoints(grid, proj4string = CRS(projection("+proj=utm +zone=32 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs "))) # CHECK CRS

#UNIQUE
#the_crs <- crs(nitrate, asText = TRUE)
#gridpoints <- st_set_crs(gridpoints, the_crs) # Project the "zion"-dataset into the srtm-crs and save it as "zion2".
#### UNIQUE END

plot(gridpoints); plot(geo_bounds, col = "red", add = TRUE)
# Crop out the points outside the boundary
cropped_gridpoints <- crop(gridpoints, as(geo_bounds, "Spatial"))
plot(cropped_gridpoints);  plot(geo_bounds, col = "red", add = TRUE)
# Convert to SpatialPixels
spgrid <- SpatialPixels(cropped_gridpoints)
coordnames(spgrid) <- c("X", "Y")
plot(spgrid)
```


### Using fitted variogram model to interpolate new data to the grid

ADELA: "Use the spatial pixel grid of the region, `spgrid`, and the variogram model of OM, `v_model` from previous exercises."

```{r}
# Adjust the kaz_geo CRS to be consistent with spgrid
crs(as(nitrate, "Spatial"), asText = TRUE) == crs(spgrid, asText = TRUE)
# Despite the statement above krige() is erroring out due to CRS misalignment, so forcing it here:
nitrate_sp <- as(nitrate, "Spatial")
crs(nitrate_sp) <- crs(spgrid)
# Do kriging predictions over the grid
nitrate_grid <- krige(Seneste_mgl ~ X + Y, nitrate_sp, newdata = spgrid, model = v_model)
# Plot the soil-nutrient predictions in a grid



#UNIQUE:
#Plotting raster:
tm_shape(nitrate_grid[1])  +
  tm_raster(title = "Nitrate mg/l", 
            style = "cont",
            palette = "-RdYlGn") +
  tm_credits(text = "Johan Horsmans & Emil Jessen") +
  tm_layout(main.title = "Nitrate pollution map")

#Points overlayed on raster:
tm_shape(nitrate_grid[1])  +
  tm_raster(title = "Nitrate mg/l", 
            style = "cont",
            palette = "-RdYlGn") +
tm_shape(nitrate) +
  tm_dots()
###

```


